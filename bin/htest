#!/bin/sh -e
#L:
#L:  MIT License
#L:  
#l:  Bug reports, feature requests to gemini|https://harkadev.com/oss
#l:  Copyright (c) 2022 Harkaitz Agirre, harkaitz.aguirre@gmail.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
##:
#h: Usage: $0 [SUITE [TEST|all]]
#h:
#h: This program helps launching tests written in bash(1) language.
#h:
#h: A "test suite" is defined as a directory, a "test" is defined as
#h: a bash script inside that directory. "$0" searches tests in this
#h: order: 
#h:
#h:     - PWD/tests                   : It gets the name "local".
#h:     - /usr/local/share/NAME/tests : Installed on /usr/local.
#h:     - /usr/share/NAME/tests       : Installed on /usr
#h:
#h: A "test" must end in ".sh". It runs in the following environment.
#h:
#h:     - PATH+= The directory containing the tests directory.
#h:     - PATH+= The tests directory.
#h:     - PATH+= The directory named "build" next to "tests" dir.
#h:     - PATH+= /usr/local/bin.
#h:     - PWD  = The directory the test is placed in.
#h:
#h: Available commands:
#h:
#h: ... ls    [SUITE] [REGEX] : List test suites.
#h: ...       SUITE   [REGEX] : Run tests in suite.
htest() {
    case "${1}" in
        '') htest_ls; return 0;;
        *)  local suite="${1}"; shift;;
    esac
    case "${1}" in
        all) htest_run "${suite}";;
        '')  htest_ls  "${suite}" | xargs -L 1 basename;;
        *)   htest_run "${suite}" "$@";;
    esac
}
## -----------------------------------------------------------------------------
htest_ls() {
    if test -n "$1";then
        htest_ls_tests "$@"
    else
        htest_ls_suites "$@"
    fi
}
htest_ls_suites() {
    local d=
    if test -d tests;then
        printf '%-20s : %s\n' "local" "`pwd`/tests"
    fi
    for p in /usr/local/share /usr/share;do
        if test -d "${p}";then
            find "${p}" -mindepth 2 -maxdepth 2 -iregex "${p}/[^/][^/]*/tests"
        fi
    done | while read -r d;do
        local n="`dirname ${d} | xargs basename`"
        printf '%-20s : %s\n' "${n}" "${d}"
    done
    
}
htest_ls_tests() {
    if test ! -n "${1}";then
        htest_error "Please specify a test suite name or directory."
        return 1
    elif test -d "${1}";then
        local pwd="`pwd`"
        cd "${1}"
        local d="`pwd`"
        cd "${pwd}"
    else
        local d="`htest_ls_suites | sed -n "s|^${1}  *: *||p"`"
        if test ! -n "${d}";then
            htest_error "Test suite ${1} not found."
            return 1
        fi
    fi
    find "${d}"                       \
         -type f                      \
         -and                         \
         -iregex '.*/'"${2}"'[^/]*$'  \
         -and                         \
         '-('                         \
         -path "*.sh" -or -executable \
         '-)' | sort
}
htest_run() {
    local t=
    for t in `htest_ls_tests "$@"`;do
        hterm_run_test "${t}"
    done
}
hterm_run_test() {
    local t="$1"
    local d1="`printf '%s\n' "${t}" | sed -n 's|/tests/.*||p'`"
    local d2="`dirname "${t}"`"
    local d3="${d2}/build"
    local pwd="`pwd`"
    echo "== `basename "$t"`"
    cd "${d2}"
    case "${t}" in
        *.sh) env PATH="${d2}:${d3}:${d1:+${d1}:}${PATH}:/usr/local/bin" /bin/bash -e "${t}";;
        *)    env PATH="${d2}:${d3}:${d1:+${d1}:}${PATH}:/usr/local/bin" "${t}"      ;;
    esac
    cd "${pwd}"
}




## -----------------------------------------------------------------------------
htest_info()  { echo "${SCRNAME}: $*" >&2; }
htest_error() { htest_info "error: $*";    }
SCRNAME="`basename "$0"`"
if test @"${SCRNAME}" = @"htest";then
    case "${1}" in
        -h|--help)
            sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|${SCRNAME}|g"
            echo ""
            sed -n 's/^ *#l: \{0,2\}//p' "$0"
            ;;
        *)
            htest "$@"
            ;;
    esac
fi

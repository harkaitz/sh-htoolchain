#!/bin/sh -e
#L:
#l:  Copyright (c) 2018 Openvirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
##:
#h: Usage: $0 ...
#h:
#h: ... show : Show configuration.
#h:
#h: ... prefix     : Install prefix.
#h: ... binutils   : Install binutils.
#h: ... wrappers   : Install clang/clang++ wrappers.
#h: ... sysroot    : Download and install sysroot.
#h: ... env-script : Install environment script.
#h:
#h: ... all       : Build all missing parts of the toolchain.
#h: ... all-force : Build all the toolchain.
. htoolchain-util
. sysroot-fix
htoolchain_freebsd() {
    local cmd="$1"
    shift
    case "${cmd}" in
        show)       htoolchain_freebsd_show_variables       ;;
        prefix)     freebsd_prefix                          ;;
        binutils)   freebsd_binutils                        ;;
        wrappers)   freebsd_wrappers                        ;;
        sysroot)    freebsd_sysroot                         ;;
        env-script) freebsd_env_script                      ;;
        all)        freebsd_all                             ;;
        all-force)  FORCE=y freebsd_all                     ;;
        *)          hlog fatal "Invalid arguments: ${cmd}." ;;
    esac
}
htoolchain_freebsd_show_variables() {
    hterm vars                    \
          -                       \
          FREEBSD_TARGET          \
          FREEBSD_TOOLDIR         \
          FREEBSD_SYSROOT         \
          FREEBSD_ENV_SCRIPT      \
          -                       \
          FREEBSD_BINUTILS_V      \
          FREEBSD_SYSROOT_AMD64_V \
          -
}
htoolchain_freebsd_calc_variables() {
    FREEBSD_TARGET="x86_64-pc-freebsd12"
    FREEBSD_TOOLDIR="${FREEBSD_TOOLDIR:-${HTOOLCHAIN_TOOLDIR}}"
    FREEBSD_SYSROOT="${FREEBSD_SYSROOT:-${FREEBSD_TOOLDIR}/${FREEBSD_TARGET}}"
    FREEBSD_ENV_SCRIPT="${FREEBSD_ENV_SCRIPT:-/usr/local/bin/${FREEBSD_TARGET}-env}"
    FREEBSD_BINUTILS_V="${FREEBSD_BINUTILS_V:-2.37}"
    FREEBSD_SYSROOT_AMD64_V="${FREEBSD_SYSROOT_AMD64_V:-amd64/12.2-RELEASE}"
}
## -----------------------------------------------------------------------------
freebsd_prefix() {
    htoolchain_util gen-prefix
    vrun sudo mkdir -p "${FREEBSD_SYSROOT}"
    vrun sudo chown -R "${HTOOLCHAIN_OWNER}" "${FREEBSD_SYSROOT}"
}
freebsd_binutils() {
    local v="${FREEBSD_BINUTILS_V}" pwd="`pwd`"
    local url="http://ftp.gnu.org/gnu/binutils/binutils-${v}.tar.bz2"
    local src="`getsrc_tar "${url}"`"
    vcd + "${src}"
    vrun make clean     || true
    vrun make distclean || true
    vrun ./configure                              \
         --prefix="${FREEBSD_TOOLDIR}"            \
         --target="${FREEBSD_TARGET}"             \
         --with-sysroot="${FREEBSD_SYSROOT}"      \
         --with-lib-path="${FREEBSD_SYSROOT}/lib" \
         --disable-nls        \
         --disable-static     \
         --enable-64-bit-bfd  \
         --disable-multilib   \
         --enable-gold=yes    \
         --enable-plugins     \
         --enable-threads     \
         --disable-werror     \
         CC=clang CXX=clang++
    vrun make
    vrun make install
    vcd - "${pwd}"
}
freebsd_wrappers() {
    local x=
    local clang="${FREEBSD_TOOLDIR}/bin/${FREEBSD_TARGET}-clang"
    local clangpp="${FREEBSD_TOOLDIR}/bin/${FREEBSD_TARGET}-clang++"
    for x in "${clang}" "${clangpp}";do
        hlog info "Creating ${x} ..."
        mkdir -p "`dirname "${x}"`"
        if true;then
            echo '#!/bin/sh -e'
            echo 'export LANG=C'
            echo 'export LD_LIBRARY_PATH='
            case "${x}" in
                *-clang++) echo "exec clang++ \\";;
                *-clang)   echo "exec clang   \\";;
            esac
            echo "    -target  x86_64-unknown-freebsd10.0              \\"
            echo "    -isystem ${FREEBSD_SYSROOT}/usr/local/include    \\"
            echo "    -isystem ${FREEBSD_SYSROOT}/usr/include          \\"
            echo "    -Wl,-rpath-link,${FREEBSD_SYSROOT}/usr/local/lib \\"
            echo "    -Wl,-rpath-link,${FREEBSD_SYSROOT}/usr/lib       \\"
            echo "    -Wl,-rpath-link,${FREEBSD_SYSROOT}/lib           \\"
            echo "    --sysroot=${FREEBSD_SYSROOT}/                    \\"
            echo "    \"\$@\"                                          \\"
            echo "    -Wno-unused-command-line-argument                \\"
            echo "    -lexecinfo"
        fi > "${x}"
        chmod +x "${x}"
    done
}
freebsd_sysroot() {
    local v="${FREEBSD_SYSROOT_AMD64_V}"
    local url="http://ftp.plusline.de/FreeBSD/releases/${v}/base.txz"
    local tar="`getsrc_cached -n freebsd-base.txz "${url}"`"
    test -n "${tar}"
    vrun tar xf "${tar}" -C "${FREEBSD_SYSROOT}"
    vrun sysroot_fix -lkp "${FREEBSD_SYSROOT}"
}
freebsd_env_script() {
    hlog info "Creating ${FREEBSD_ENV_SCRIPT} ..."
    sudo tee "${FREEBSD_ENV_SCRIPT}" <<-EOF >/dev/null
	#!/bin/sh -e
	. hcross-env-c
	hcross_env_c                              \\
	    type=clang                            \\
	    path="${FREEBSD_TOOLDIR}/bin"         \\
	    tool_prefix="${FREEBSD_TARGET}-"      \\
	    prefix="${FREEBSD_SYSROOT}/usr/local" \\
	    prefixes="${FREEBSD_SYSROOT}/usr/local ${FREEBSD_SYSROOT}/usr ${FREEBSD_SYSROOT}"
	EOF
    sudo chmod +x "${FREEBSD_ENV_SCRIPT}"
}
## -----------------------------------------------------------------------------
freebsd_all() {
    hlog info "Started: `date`"
    hlog info "Log to: ${HTOOLCHAIN_LOG}"
    rm -f "${HTOOLCHAIN_LOG}"
    if true;then
        hlog info "Creating directories ..."
        freebsd_prefix >> "${HTOOLCHAIN_LOG}" 2>&1
    fi
    if test ! -f "${FREEBSD_TOOLDIR}/bin/${FREEBSD_TARGET}-ld" || test -n "${FORCE}";then
        hlog info "Building binutils ..."
        freebsd_binutils >> "${HTOOLCHAIN_LOG}" 2>&1
    fi
    if test ! -f "${FREEBSD_SYSROOT}/bin/sh" || test -n "${FORCE}";then
        hlog info "Download and extracting sysroot ..."
        freebsd_sysroot >> "${HTOOLCHAIN_LOG}" 2>&1
    fi
    if true;then
        hlog info "Installing wrappers ..."
        freebsd_wrappers >> "${HTOOLCHAIN_LOG}" 2>&1
    fi
    if true;then
        hlog info "Creating scripts ..."
        freebsd_env_script >> "${HTOOLCHAIN_LOG}" 2>&1
    fi
    hlog info "Creating ${FREEBSD_ENV_SCRIPT} ..."
    hlog info "Finished: `date`"
}
## -----------------------------------------------------------------------------
htoolchain_freebsd_calc_variables
hmain -f "htoolchain-freebsd" htoolchain_freebsd "$@"
